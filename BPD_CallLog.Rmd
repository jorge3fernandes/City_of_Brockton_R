---
title: "Brockton Police Call Log Research"
author: "Jorge Fernandes"
date: "February 7, 2016"
output: html_document
---

By inspecting the website (http://brocktonpolice.com/category/police-log/), you can see that the data is archived by date. Noticing that, will make our extraction easier. We will just manipulate the URLs to make it go through the whole archive.

```{r, echo = TRUE}
library(plyr)
library(RCurl)
library(stringr)
library(pdftables)

```


By examining the urls, sometimes there is no leading zero before days and months less than ten.  

Here I'm creating all the urls with leading zeros where days and months are less than ten.
```{r}

prefix <- "http://brocktonpolice.com/wp-content/uploads/"
AllDays <- seq.Date(from = as.Date('2015-01-01'), to = Sys.Date(), by = "day")
links1 <- paste0(prefix, format(AllDays, '%Y/%m/%m%d%y'), '.pdf')

```

Here I'm creating all the urls with without leading zeros where days and months are less than ten.

```{r}

AllDays_NL <- gsub("0", "", format(AllDays, '%m%d%y'))
links2 <- paste0(prefix, format(AllDays, '%Y/%m/'), AllDays_NL,'.pdf')

```

Since there is not a clear pattern on when we do and don't have a leading zero, we will put the two lists together and extract the data whenever we have a match
```{r}

link <- c(links1,links2)

```

Here we go against the website and download the data.

```{r}
folder <- getwd()
filenames<- str_c(format(seq.Date(from = as.Date("2015-01-01"), to = Sys.Date(), by = "day"),"%Y_%m_%d"),".pdf")
filenames <- c(filenames,filenames)
for (i in seq_along(link)){
      
      if (!file.exists(str_c(folder,"/",filenames[i]))) { 
                  download.file(link[i], filenames[i], mode="wb")
      } 
}

```
Since the data is in pdf format, we use pdftotext to extract text from the PDFs
Download pdftotxt from ftp://ftp.foolabs.com/pub/xpdf/xpdfbin-win-3.03.zip and extract to program files folder

```{r}
dest <- getwd()

# make a vector of PDF file names
myfiles <- list.files(path = dest, pattern = "pdf",  full.names = TRUE)

# convert each PDF file that is named in the vector into a text file 
# text file is created in the same directory as the PDFs
# note that my pdftotext.exe is in a different location to yours
lapply(myfiles, function(i) system(paste('/Users/legs_jorge/Desktop/xpdfbin-mac-3.04/bin64/pdftotext', 
             paste0('"', i, '"')), wait = FALSE) )

```

###Current effort:
Separanting the events

<<<<<<< HEAD
#
```{r}
mytxtfiles <- list.files(path = dest, pattern = "txt",  full.names = TRUE)
events <- lapply(mytxtfiles, function(i) {
  j <- paste0(scan(i, what = character()), collapse = " ")
  regmatches(j, gregexpr("(?<=Abstract).*?(?=Introduction)", j, perl=TRUE)) 
})

logsPDF <- list.files(path = dest, pattern = ".pdf", full.names = T)
n_filenames <- str_c(format(seq.Date(from = as.Date("2015-01-01"), to = Sys.Date(), by = "day"),"%Y_%m_%d"),".csv")


convert_pdf(logsPDF[i],"2015_04_18.csv", format = "csv",message = TRUE, api_key = "h7mo7omfuq2n")

data <- read.csv("2015_04_18.csv", stringsAsFactors = FALSE, header = TRUE)
```
=======
>>>>>>> 69608f7573a342fd0e5ef8fdc66060d30d26123f


