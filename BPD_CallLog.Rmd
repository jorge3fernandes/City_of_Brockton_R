---
title: "Brockton Police Call Log Research"
author: "Jorge Fernandes"
date: "February 7, 2016"
output: html_document
---

By inpecting the  website, you can see that the data is presented in an archive by date. Noticing that will make our extraction easier. we will just manipulate the URL to make it go through the whole archive.
```{r, echo = TRUE}
library(plyr)
library(RCurl)
library(stringr)
library(pdftables)
```


To make sure we get all the URLs for 2015, we do the following: 

We would have create a list of URLs where months and days are less than ten carry a leading zero.

```{r}

prefix <- "http://brocktonpolice.com/wp-content/uploads/"
AllDays <- seq.Date(from = as.Date('2015-01-01'), to = Sys.Date(), by = "day")
links1 <- paste0(prefix, format(AllDays, '%Y/%m/%m%d%y'), '.pdf')

```

We would have create a list of URLs where months and days are less than ten do not carry a leading zero.


```{r}

AllDays_NL <- gsub("0", "", format(AllDays, '%m%d%y'))
links2 <- paste0(prefix, format(AllDays, '%Y/%m/'), AllDays_NL,'.pdf')

```

We are doing it that way due to changes that occurs in the actual link format.  
Now we put everything together into an list where we will have both formats.

```{r}

link <- c(links1,links2)

```

Here we download all the PDFs.

```{r}
folder <- getwd()
filenames<- str_c(format(seq.Date(from = as.Date("2015-01-01"), to = Sys.Date(), by = "day"),"%Y_%m_%d"),".pdf")
filenames <- c(filenames,filenames)
for (i in seq_along(link)){
      
      if (!file.exists(str_c(folder,"/",filenames[i]))) { 
                  download.file(link[i], filenames[i], mode="wb")
      } 
}

```
We begin extract text from the PDFs

```{r}

# download pdftotxt from 
# ftp://ftp.foolabs.com/pub/xpdf/xpdfbin-win-3.03.zip
# and extract to program files folder

# here is a pdf for mining
# folder with 1000s of PDFs
dest <- getwd()

# make a vector of PDF file names
myfiles <- list.files(path = dest, pattern = "pdf",  full.names = TRUE)

# convert each PDF file that is named in the vector into a text file 
# text file is created in the same directory as the PDFs
# note that my pdftotext.exe is in a different location to yours
lapply(myfiles, function(i) system(paste('/Users/legs_jorge/Desktop/xpdfbin-mac-3.04/bin64/pdftotext', 
             paste0('"', i, '"')), wait = FALSE) )

```

Here we separate the events
```{r}

#
mytxtfiles <- list.files(path = dest, pattern = "txt",  full.names = TRUE)
events <- lapply(mytxtfiles, function(i) {
  j <- paste0(scan(i, what = character()), collapse = " ")
  regmatches(j, gregexpr("(?<=Abstract).*?(?=Introduction)", j, perl=TRUE)) 
})

logsPDF <- list.files(path = dest, pattern = ".pdf", full.names = T)
n_filenames <- str_c(format(seq.Date(from = as.Date("2015-01-01"), to = Sys.Date(), by = "day"),"%Y_%m_%d"),".csv")


convert_pdf(logsPDF[i],"2015_04_18.csv", format = "csv",message = TRUE, api_key = "h7mo7omfuq2n")

data <- read.csv("2015_04_18.csv", stringsAsFactors = FALSE, header = TRUE)
```


